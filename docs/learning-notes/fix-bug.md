
## 使用 Fabirc.js 内存泄漏问题

#### 背景
1.   提供出去的 js 手写板，在学习中心连做5题后导致学习中心 app 崩溃，且在 app 中书写感觉不流畅，会有轻微延迟，但是在浏览器里面打开同一个手写板不会出现此类问题

#### 排查问题
1. 因为提供出去的是 js SDK ，且浏览器里面访问是没有这个问题的。所以第一时间怀疑的是学习中心调用问题，可能是多次实例化，且没有调用销毁的方法导致的。但是和学习中心那边的沟通后发现，是只有实例化一次的。
2. 排除了可能误用方法的可能，怀疑是app本身就占用了很多的内存，于是当再加载手写板的时候内存不够，于是我们找到了 android 开发的同事，询问了一下当时复现时候的内存不够的场景。内存是够的。
3. 下一步的方向只能选择复现的场景，通过复现场景，看看哪一步的问题导致的。
4. 想学习中心要了一下能调试的页面，但是因为排期问题，需要一定的工作量，预计要一天后才能给到。所以只能这边先看一下自己的 sdk 编写的问题
5. 检查自己的代码编写，使用了性能检测的内存查看，堆快照，通过每一帧的对比，发现确实会出现 0.5M---1M 的增加，但是这种级别的增加应该不会导致内存爆栈的。
6. 使用chrome的任务处理器，查看页面的内存。发现并没有特别的上升，也只是偶尔上升，但是不操作的时候也会很快下降。
7. 为了性能的优化，查看一下代码，因为自己做了redo undo 的操作记录，所以可能会导致页面数据变大，但是这个版本中没有使用，担心是这个的影响，就将这块代码注释掉了，再次查看数据快照，稳定降在 0.5M 以下。
8. 继续查看，Fabric 的 github issue 发现提供的有解除引用的的方法，但是调用后发现并没有明显变化。只能等待第二天的测试页面，复现查看了。
9. 第二天学习中心相关测试页面给到后，在电脑上跑了以下，发现每次保存图片以后会导致页面的内存占用每次以常数级别上升。终于定位到了问题所在。
10. 下面的就比较简单，优化保存的方法。通过二分查找法，定位到是使用 fabirc.canvas.clone 方法，导致页面内存上升。因为官网上没有更好的替代方法，且这个方法必须使用（因为如果使用原 canvas 会导致绘画的内容方向偏离），所以只能使用替代方法。
11. 直接创建一个新的 fabric.StaticCanvas ,并将原来方法 toJson,  然后加载使用fabric.StaticCanvas.loadFromJSON, 然后保存图片。成功解决


#### 反思
出现问题要到一时间尝试复现，通过直接定位问题的方法，能节省一部分时间